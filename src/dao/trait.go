package dao

import (
	"context"

	"github.com/SimonHofman/EasySwapBackend/src/types/v1"
	"github.com/SimonHofman/EasySwapBase/stores/gdb/orderbookmodel/multi"
	"github.com/pkg/errors"
)

func (d *Dao) QueryItemTraits(ctx context.Context, chain string, collectionAddr string, tokenID string) ([]multi.ItemTrait, error) {
	var itemTraits []multi.ItemTrait
	if err := d.DB.WithContext(ctx).Table(multi.ItemTraitTableName(chain)).
		Select("collection_address, token_id, trait, trait_value").
		Where("collection_address = ? and token_id = ?", collectionAddr, tokenID).
		Scan(&itemTraits).Error; err != nil {
		return nil, errors.Wrap(err, "failed on query items trait info")
	}

	return itemTraits, nil
}

func (d *Dao) QueryItemsTraits(ctx context.Context, chain string, collectionAddr string, tokenIds []string) ([]multi.ItemTrait, error) {
	var itemsTraits []multi.ItemTrait
	if err := d.DB.WithContext(ctx).Table(multi.ItemTraitTableName(chain)).
		Select("collection_address, token_id, trait, trait_value").
		Where("collection_address = ? and token_id in (?)", collectionAddr, tokenIds).
		Scan(&itemsTraits).Error; err != nil {
		return nil, errors.Wrap(err, "failed on query items trait info")
	}
	return itemsTraits, nil
}

func (d *Dao) QueryCollectionTraits(ctx context.Context, chain string, collectionAddr string) ([]types.TraitCount, error) {
	var traitCounts []types.TraitCount
	if err := d.DB.WithContext(ctx).Table(multi.ItemTraitTableName(chain)).
		Select("`trait`,`trait_value`,count(*) as count").Where("collection_address = ?", collectionAddr).
		Group("`trait`,`trait_value`").
		Scan(&traitCounts).Error; err != nil {
		return nil, errors.Wrap(err, "failed on query collection trait amount")
	}

	return traitCounts, nil
}
